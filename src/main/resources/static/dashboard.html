<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Clientes - Sistema Moderno</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Nunito', sans-serif;
            color: #676767;
            background-color: #1e1e1e;
        }

        .bg-card {
            background-color: #171717;
        }
        .bg-sidebar-card-top {
            background-color: #353535;
        }
        .sidebar-separator-top {
            border-bottom: 1px solid #2e2e2e;
        }
        .sidebar-separator-bottom {
            border-top: 1px solid #2e2e2e;
        }
        .text-premium-yellow {
            color: #f7b91c;
        }
        .icon-background {
            background: #2d2d2d;
        }
        .tooltip-head {
            background: #1d1d1d;
        }
        .tooltip-body {
            background: #252525;
        }
        .search-icon {
            top: 50%;
            transform: translate(0, -50%);
        }
        .card-stack-border {
            border-bottom: 2px solid #696969;
        }
        .bg-details {
            background-color: #1e1e1e;
        }
        .add-component-head {
            background-color: #181818;
            background-image: url("https://www.transparenttextures.com/patterns/carbon-fibre.png");
        }
        .sidebar-item-selected {
            color: white;
            border-right: 2px solid white;
        }
        .sidebar-item {
            border-right: 2px solid transparent;
        }
        .sidebar-item:hover {
            color: #a1a0a0;
        }

        /* Layout principal */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #171717;
            border-right: 1px solid #2e2e2e;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2e2e2e;
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: 800;
            color: #f7b91c;
            margin-bottom: 10px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 15px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px;
            color: #a1a0a0;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #2d2d2d;
            color: #f7b91c;
        }

        .sidebar-menu a.active {
            border-right: 3px solid #f7b91c;
        }

        /* Conteúdo principal */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        .content-header {
            background: linear-gradient(135deg, #171717 0%, #2d2d2d 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #2e2e2e;
        }

        .content-title {
            color: #f7b91c;
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .content-subtitle {
            color: #a1a0a0;
            font-size: 1.1em;
        }

        /* Cards de estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #171717;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #2e2e2e;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f7b91c, #f39c12);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            color: #f7b91c;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #a1a0a0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Sistema de abas */
        .nav-tabs {
            display: flex;
            background: #171717;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            border: 1px solid #2e2e2e;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: #a1a0a0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #f7b91c 0%, #f39c12 100%);
            color: #1e1e1e;
        }

        .nav-tab:hover:not(.active) {
            background: #2d2d2d;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Formulário */
        .form-section {
            background: #171717;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #2e2e2e;
        }

        .form-section h2 {
            color: #f7b91c;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            border-bottom: 2px solid #f7b91c;
            padding-bottom: 15px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #a1a0a0;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #2e2e2e;
            border-radius: 10px;
            font-size: 16px;
            background: #1e1e1e;
            color: #fff;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f7b91c;
            box-shadow: 0 0 0 3px rgba(247, 185, 28, 0.1);
            background: #252525;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        /* Botões */
        .btn {
            background: linear-gradient(135deg, #f7b91c 0%, #f39c12 100%);
            color: #1e1e1e;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(247, 185, 28, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #1e1e1e;
        }

        /* Tabelas */
        .clients-table {
            width: 100%;
            border-collapse: collapse;
            background: #171717;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .clients-table th {
            background: #2d2d2d;
            color: #f7b91c;
            padding: 20px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clients-table td {
            padding: 20px;
            border-bottom: 1px solid #2e2e2e;
            color: #a1a0a0;
        }

        .clients-table tr:hover {
            background: #1e1e1e;
        }

        /* Gráfico */
        .chart-container {
            background: #171717;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            border: 1px solid #2e2e2e;
            height: 400px;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .chart-title {
            color: #f7b91c;
            font-size: 1.5em;
            font-weight: 700;
        }

        .chart-controls {
            display: flex;
            gap: 15px;
        }

        .chart-control-btn {
            background: #2d2d2d;
            border: 1px solid #2e2e2e;
            color: #a1a0a0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-control-btn:hover,
        .chart-control-btn.active {
            background: #f7b91c;
            color: #1e1e1e;
        }

        /* Alertas */
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none;
            font-weight: 600;
        }

        .alert-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            border: 1px solid #20c997;
        }

        .alert-error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            border: 1px solid #c82333;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Dashboard</div>
                <div style="color: #a1a0a0;">Sistema de Clientes</div>
            </div>
            
            <ul class="sidebar-menu">
                                 <li><a href="#" class="active" onclick="showTab('cadastro')">Cadastrar Clientes</a></li>
                 <li><a href="#" onclick="showTab('clientes')">Clientes Cadastrados</a></li>
                 <li><a href="#" onclick="showTab('notificacoes')">Notificações</a></li>
            </ul>
        </div>

        <!-- Conteúdo Principal -->
        <div class="main-content">
            <!-- Header -->
            <div class="content-header">
                <h1 class="content-title">Dashboard de Clientes</h1>
                <p class="content-subtitle">Sistema moderno para gerenciamento completo</p>
            </div>

            <!-- Alertas -->
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>

            <!-- Estatísticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalClientes">0</div>
                    <div class="stat-label">Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalNotificacoes">0</div>
                                         <div class="stat-label">Notificações</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="clientesHoje">0</div>
                    <div class="stat-label">Cadastrados Hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="taxaSucesso">0%</div>
                    <div class="stat-label">Taxa de Sucesso</div>
                </div>
            </div>

            <!-- Aba 1: Cadastrar Clientes -->
            <div id="cadastro" class="tab-content active">
                <div class="form-section">
                    <h2>Cadastrar Novo Cliente</h2>
                    <form id="clienteForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nome">Nome Completo *</label>
                                <input type="text" id="nome" name="nome" required placeholder="Digite o nome completo">
                            </div>
                            <div class="form-group">
                                                                 <label for="cep">CEP *</label>
                                <input type="text" id="cep" name="cep" required placeholder="00000-000" maxlength="9">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="logradouro">Logradouro</label>
                                <input type="text" id="logradouro" name="logradouro" placeholder="Rua, Avenida, etc.">
                            </div>
                            <div class="form-group">
                                <label for="bairro">Bairro</label>
                                <input type="text" id="bairro" name="bairro" placeholder="Nome do bairro">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cidade">Cidade</label>
                                <input type="text" id="cidade" name="cidade" placeholder="Nome da cidade">
                            </div>
                            <div class="form-group">
                                <label for="uf">Estado</label>
                                <select id="uf" name="uf">
                                    <option value="">Selecione...</option>
                                    <option value="SP">Sao Paulo</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="PR">Parana</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="complemento">Complemento</label>
                            <input type="text" id="complemento" name="complemento" placeholder="Apartamento, bloco, etc.">
                        </div>
                        <div style="margin-top: 30px;">
                            <button type="submit" class="btn">Cadastrar Cliente</button>
                            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
                            <button type="button" class="btn btn-warning" onclick="buscarCep()">Buscar CEP</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Aba 2: Clientes Cadastrados -->
            <div id="clientes" class="tab-content">
                <div class="form-section">
                    <h2>Clientes Cadastrados</h2>
                    <button class="btn btn-secondary" onclick="carregarClientes()">Atualizar Lista</button>
                    
                    <div style="margin-top: 20px;">
                        <table class="clients-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>CEP</th>
                                                                         <th>Endereço</th>
                                                                         <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientesTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #6c757d;">Nenhum cliente cadastrado ainda</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Gráfico -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Evolução de Clientes</h3>
                            <div class="chart-controls">
                                                                 <button class="chart-control-btn active" onclick="changeChartPeriod('month')">Mês</button>
                                 <button class="chart-control-btn" onclick="changeChartPeriod('week')">Semana</button>
                                 <button class="chart-control-btn" onclick="changeChartPeriod('year')">Ano</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="clientesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba 3: Notificações -->
            <div id="notificacoes" class="tab-content">
                <div class="form-section">
                                         <h2>Notificações do Sistema</h2>
                     <button class="btn btn-secondary" onclick="carregarNotificacoes()">Atualizar Notificações</button>
                    
                    <div style="margin-top: 20px;">
                        <table class="clients-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Mensagem</th>
                                    <th>Tipo</th>
                                    <th>Cliente</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="notificacoesTableBody">
                                                                 <tr>
                                     <td colspan="6" style="text-align: center; color: #6c757d;">Nenhuma notificação encontrada</td>
                                 </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const clienteForm = document.getElementById('clienteForm');
        const alertSuccess = document.getElementById('alertSuccess');
        const alertError = document.getElementById('alertError');
        let clientesChart = null;
        let currentChartPeriod = 'month';


        function showTab(tabName) {

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            

            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => link.classList.remove('active'));
            

            document.getElementById(tabName).classList.add('active');
            

            event.target.classList.add('active');
            

            if (tabName === 'clientes') {
                carregarClientes();
                setTimeout(async () => await atualizarGrafico(), 500);
            } else if (tabName === 'notificacoes') {
                carregarNotificacoes();
            }
        }


        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        });


        async function buscarCep() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length !== 8) {
                                 mostrarAlerta('Por favor, digite um CEP válido com 8 dígitos', 'error');
                return;
            }
            try {
                const response = await fetch('https://viacep.com.br/ws/' + cep + '/json/');
                const data = await response.json();
                if (data.erro) {
                    mostrarAlerta('CEP não encontrado', 'error');
                    return;
                }
                document.getElementById('logradouro').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('uf').value = data.uf || '';
                mostrarAlerta('CEP encontrado e campos preenchidos automaticamente!', 'success');
            } catch (error) {
                mostrarAlerta('Erro ao buscar CEP: ' + error.message, 'error');
            }
        }

        clienteForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(clienteForm);
            const cliente = {
                nome: formData.get('nome'),
                endereco: {
                    cep: formData.get('cep').replace(/\D/g, ''),
                    logradouro: formData.get('logradouro') || '',
                    complemento: formData.get('complemento') || '',
                    bairro: formData.get('bairro') || '',
                    localidade: formData.get('cidade') || '',
                    uf: formData.get('uf') || ''
                }
            };
            
            console.log('Cliente a ser enviado:', cliente);
            
                         if (!cliente.nome || !cliente.endereco.cep) {
                 mostrarAlerta('Nome e CEP são obrigatórios', 'error');
                 return;
             }
            
            try {
                const response = await fetch(API_BASE + '/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cliente)
                });
                
                                                 if (response.ok) {
                    const clienteCriado = await response.json();
                    mostrarAlerta('Cliente ' + clienteCriado.nome + ' cadastrado com sucesso! ID: ' + clienteCriado.id, 'success');
                    limparFormulario();
                    
                    await carregarNotificacoes();
                    
                    await carregarClientes();
                    await atualizarEstatisticas();
                    await atualizarEstatisticasNotificacoes();
                    
                    setTimeout(async () => await atualizarGrafico(), 1000);
                    
                    const clientesResponse = await fetch(API_BASE + '/clientes');
                    if (clientesResponse.ok) {
                        const clientes = await clientesResponse.json();
                        console.log('=== CADASTRANDO CLIENTE ===');
                        console.log('Total de clientes após cadastro:', clientes.length);
                        console.log('Contador de exclusões:', window.notificacoesExclusao || 0);
                        calcularTaxaSucesso(clientes);
                    }
                } else {
                    const error = await response.text();
                    mostrarAlerta('Erro ao cadastrar cliente: ' + error, 'error');
                }
                             } catch (error) {
                     mostrarAlerta('Erro de conexão: ' + error.message, 'error');
                 }
        });

                async function carregarClientes() {
            try {
                const response = await fetch(API_BASE + '/clientes');
                if (response.ok) {
                    const clientes = await response.json();
                    const tbody = document.getElementById('clientesTableBody');
                    
                    if (clientes.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">Nenhum cliente cadastrado ainda</td></tr>';
                        return;
                    }
                    
                                         tbody.innerHTML = clientes.map(function(cliente) {
                         const endereco = cliente.endereco || {};
                                                  console.log('Cliente:', cliente);
                         console.log('Endereco:', endereco);
                         
                         let enderecoCompleto = '';
                         let camposPreenchidos = 0;
                         
                         if (endereco.logradouro && endereco.logradouro.trim() !== '') {
                             enderecoCompleto += endereco.logradouro;
                             camposPreenchidos++;
                         }
                         if (endereco.bairro && endereco.bairro.trim() !== '') {
                             enderecoCompleto += enderecoCompleto ? ', ' + endereco.bairro : endereco.bairro;
                             camposPreenchidos++;
                         }
                         if (endereco.localidade && endereco.localidade.trim() !== '') {
                             enderecoCompleto += enderecoCompleto ? ', ' + endereco.localidade : endereco.localidade;
                             camposPreenchidos++;
                         }
                         if (endereco.uf && endereco.uf.trim() !== '') {
                             enderecoCompleto += enderecoCompleto ? ', ' + endereco.uf : endereco.uf;
                             camposPreenchidos++;
                         }
                         
                         if (camposPreenchidos === 0) {
                             enderecoCompleto = 'Endereço não informado';
                         } else if (camposPreenchidos === 1) {
                             enderecoCompleto += ' (Apenas CEP)';
                         }
                         
                         return '<tr>' +
                             '<td>' + (cliente.id || 'N/A') + '</td>' +
                             '<td>' + (cliente.nome || 'N/A') + '</td>' +
                             '<td>' + (endereco.cep || 'N/A') + '</td>' +
                             '<td>' + enderecoCompleto + '</td>' +
                             '<td><button class="btn btn-secondary" onclick="deletarCliente(' + (cliente.id || 0) + ')">Deletar</button></td>' +
                             '</tr>';
                     }).join('');
                } else {
                    mostrarAlerta('Erro ao carregar clientes', 'error');
                }
            } catch (error) {
                mostrarAlerta('Erro de conexão: ' + error.message, 'error');
            }
        }

                async function carregarNotificacoes() {
            try {
                const response = await fetch(API_BASE + '/notificacoes');
                if (response.ok) {
                    const notificacoes = await response.json();
                    const tbody = document.getElementById('notificacoesTableBody');
                    
                    if (notificacoes.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d;">Nenhuma notificação encontrada</td></tr>';
                    } else {
                        tbody.innerHTML = notificacoes.map(function(notif) {
                            return '<tr>' +
                                '<td>' + (notif.id || 'N/A') + '</td>' +
                                '<td>' + (notif.mensagem || 'N/A') + '</td>' +
                                '<td>' + (notif.tipo || 'N/A') + '</td>' +
                                '<td>' + (notif.cliente ? notif.cliente.nome : 'N/A') + '</td>' +
                                '<td>' + (notif.dataEnvio ? new Date(notif.dataEnvio).toLocaleString('pt-BR') : 'N/A') + '</td>' +
                                '<td>' + (notif.enviada ? 'Enviada' : 'Pendente') + '</td>' +
                                '</tr>';
                        }).join('');
                    }
                    
                    document.getElementById('totalNotificacoes').textContent = notificacoes.length;
                    
                    const notificacoesExclusao = notificacoes.filter(n => 
                        n.tipo === 'PUSH' && n.mensagem.includes('removido')
                    ).length;
                    
                    if (typeof window.notificacoesExclusao === 'undefined') {
                        window.notificacoesExclusao = notificacoesExclusao;
                        console.log('Contador inicializado com:', notificacoesExclusao);
                    } else if (notificacoesExclusao > window.notificacoesExclusao) {
                        console.log('Contador atualizado de', window.notificacoesExclusao, 'para', notificacoesExclusao);
                        window.notificacoesExclusao = notificacoesExclusao;
                    } else {
                        console.log('Contador mantido como:', window.notificacoesExclusao, '(não sobrescrito)');
                    }
                    
                    const clientesResponse = await fetch(API_BASE + '/clientes');
                    if (clientesResponse.ok) {
                        const clientes = await clientesResponse.json();
                        calcularTaxaSucesso(clientes);
                    }
                    
                    console.log('=== CARREGANDO NOTIFICAÇÕES ===');
                    console.log('Notificações de exclusão encontradas:', notificacoesExclusao);
                    console.log('Contador global atual:', window.notificacoesExclusao);
                    console.log('Total de notificações:', notificacoes.length);
                } else {
                    mostrarAlerta('Erro ao carregar notificações', 'error');
                }
            } catch (error) {
                mostrarAlerta('Erro de conexão: ' + error.message, 'error');
            }
        }

        async function deletarCliente(id) {
            if (!confirm('Tem certeza que deseja deletar este cliente?')) return;
            
            console.log('Tentando deletar cliente com ID:', id);
            
            try {
    
                const checkResponse = await fetch(API_BASE + '/clientes/' + id);
                if (!checkResponse.ok) {
                    mostrarAlerta('Cliente não encontrado', 'error');
                    return;
                }
                
                const response = await fetch(API_BASE + '/clientes/' + id, { 
                    method: 'DELETE'
                });
                
                console.log('Resposta da API:', response.status, response.statusText);
                
                if (response.ok) {
                    mostrarAlerta('Cliente deletado com sucesso!', 'success');
                    
                    window.notificacoesExclusao = (window.notificacoesExclusao || 0) + 1;
                    console.log('=== DELETANDO CLIENTE ===');
                    console.log('Contador de exclusões ANTES:', (window.notificacoesExclusao || 0) - 1);
                    console.log('Contador de exclusões DEPOIS:', window.notificacoesExclusao);
                    
                    await carregarNotificacoes();
                    
                    await carregarClientes();
                    await atualizarEstatisticas();
                    await atualizarEstatisticasNotificacoes();
                    await atualizarGrafico();
                    
                    const clientesResponse = await fetch(API_BASE + '/clientes');
                    if (clientesResponse.ok) {
                        const clientes = await clientesResponse.json();
                        console.log('Clientes restantes após deletar:', clientes.length);
                        console.log('Forçando recálculo da taxa com contador atual:', window.notificacoesExclusao);
                        calcularTaxaSucesso(clientes);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Erro da API:', errorText);
                    console.error('Status:', response.status, response.statusText);
                    mostrarAlerta('Erro ao deletar cliente: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                mostrarAlerta('Erro de conexão: ' + error.message, 'error');
            }
        }

        function limparFormulario() {
            clienteForm.reset();
            ocultarAlertas();
        }

        function mostrarAlerta(mensagem, tipo) {
            ocultarAlertas();
            const alert = tipo === 'success' ? alertSuccess : alertError;
            alert.textContent = mensagem;
            alert.style.display = 'block';
            setTimeout(function() { alert.style.display = 'none'; }, 5000);
        }

        function ocultarAlertas() {
            alertSuccess.style.display = 'none';
            alertError.style.display = 'none';
        }

        async function atualizarEstatisticas() {
            try {
                const response = await fetch(API_BASE + '/clientes');
                if (response.ok) {
                    const clientes = await response.json();
                    document.getElementById('totalClientes').textContent = clientes.length;
                    
                    const hoje = new Date().toDateString();
                    const clientesHoje = clientes.filter(c => {
                        const dataCriacao = c.dataCriacao || new Date();
                        return new Date(dataCriacao).toDateString() === hoje;
                    }).length;
                    document.getElementById('clientesHoje').textContent = clientesHoje;
                    
                    calcularTaxaSucesso(clientes);
                }
            } catch (error) {
                console.error('Erro ao carregar estatisticas:', error);
            }
        }
        
        function calcularTaxaSucesso(clientes) {
            try {
                const totalCadastrados = clientes.length;
                
                const notificacoesExclusao = window.notificacoesExclusao || 0;
                
                console.log('=== CÁLCULO TAXA DE SUCESSO ===');
                console.log('Total de clientes:', totalCadastrados);
                console.log('Notificações de exclusão:', notificacoesExclusao);
                console.log('Contador global:', window.notificacoesExclusao);
                
                if (totalCadastrados === 0) {
                    document.getElementById('taxaSucesso').textContent = '0%';
                    document.getElementById('taxaSucesso').style.color = '#dc3545';
                    console.log('Taxa definida como 0% (sem clientes)');
                    return;
                }
                
                const clientesAtivos = Math.max(0, totalCadastrados - notificacoesExclusao);
                const taxa = totalCadastrados > 0 ? (clientesAtivos / totalCadastrados) * 100 : 0;
                
                document.getElementById('taxaSucesso').textContent = taxa.toFixed(1) + '%';
                
                console.log('Taxa calculada:', taxa.toFixed(1) + '%');
                console.log('Fórmula: (', clientesAtivos, '/', totalCadastrados, ') * 100 =', taxa);
                console.log('Clientes Ativos:', clientesAtivos, '| Total Cadastrados:', totalCadastrados, '| Deletados:', notificacoesExclusao);
                
                const taxaElement = document.getElementById('taxaSucesso');
                if (taxa >= 80) {
                    taxaElement.style.color = '#28a745';
                    console.log('Cor aplicada: Verde');
                } else if (taxa >= 60) {
                    taxaElement.style.color = '#ffc107';
                    console.log('Cor aplicada: Amarelo');
                } else {
                    taxaElement.style.color = '#dc3545';
                    console.log('Cor aplicada: Vermelho');
                }
                console.log('=== FIM CÁLCULO ===');
            } catch (error) {
                console.error('Erro ao calcular taxa de sucesso:', error);
                document.getElementById('taxaSucesso').textContent = '0%';
                document.getElementById('taxaSucesso').style.color = '#dc3545';
            }
        }

        async function atualizarEstatisticasNotificacoes() {
            try {
                const response = await fetch(API_BASE + '/notificacoes');
                if (response.ok) {
                    const notificacoes = await response.json();
                    document.getElementById('totalNotificacoes').textContent = notificacoes.length;
                }
            } catch (error) {
                console.error('Erro ao carregar estatisticas de notificacoes:', error);
            }
        }

        async function atualizarGrafico() {
            const ctx = document.getElementById('clientesChart');
            if (!ctx) return;
            
            if (clientesChart) {
                clientesChart.destroy();
            }
            
            const data = await gerarDadosGrafico();
            clientesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Clientes Cadastrados',
                        data: data.values,
                        borderColor: '#f7b91c',
                        backgroundColor: 'rgba(247, 185, 28, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#a1a0a0',
                                font: {
                                    family: 'Nunito',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a1a0a0' },
                            grid: { color: '#2e2e2e' }
                        },
                        y: {
                            ticks: { color: '#a1a0a0' },
                            grid: { color: '#2e2e2e' }
                        }
                    }
                }
            });
        }

        async function gerarDadosGrafico() {
            try {
                const response = await fetch(API_BASE + '/clientes');
                if (!response.ok) {
                    throw new Error('Erro ao carregar clientes');
                }
                
                const clientes = await response.json();
                console.log('Clientes para gráfico:', clientes);
                
                const hoje = new Date();
                let labels = [];
                let values = [];
                
                if (currentChartPeriod === 'week') {

                    for (let i = 6; i >= 0; i--) {
                        const data = new Date(hoje);
                        data.setDate(hoje.getDate() - i);
                        const dataStr = data.toLocaleDateString('pt-BR', { weekday: 'short' });
                        labels.push(dataStr);
                        

                        const dataInicio = new Date(data);
                        dataInicio.setHours(0, 0, 0, 0);
                        const dataFim = new Date(data);
                        dataFim.setHours(23, 59, 59, 999);
                        
                        const clientesNesteDia = clientes.filter(cliente => {
                            if (!cliente.dataCriacao) return false;
                            const dataCriacao = new Date(cliente.dataCriacao);
                            return dataCriacao >= dataInicio && dataCriacao <= dataFim;
                        }).length;
                        
                        values.push(clientesNesteDia);
                    }
                } else if (currentChartPeriod === 'month') {

                    for (let i = 11; i >= 0; i--) {
                        const data = new Date(hoje);
                        data.setMonth(hoje.getMonth() - i);
                        const dataStr = data.toLocaleDateString('pt-BR', { month: 'short' });
                        labels.push(dataStr);
                        

                        const mesInicio = new Date(data.getFullYear(), data.getMonth(), 1);
                        const mesFim = new Date(data.getFullYear(), data.getMonth() + 1, 0, 23, 59, 59, 999);
                        
                        const clientesNesteMes = clientes.filter(cliente => {
                            if (!cliente.dataCriacao) return false;
                            const dataCriacao = new Date(cliente.dataCriacao);
                            return dataCriacao >= mesInicio && dataCriacao <= mesFim;
                        }).length;
                        
                        values.push(clientesNesteMes);
                    }
                } else if (currentChartPeriod === 'year') {

                    for (let i = 4; i >= 0; i--) {
                        const ano = hoje.getFullYear() - i;
                        labels.push(ano.toString());
                        

                        const anoInicio = new Date(ano, 0, 1);
                        const anoFim = new Date(ano, 11, 31, 23, 59, 59, 999);
                        
                        const clientesNesteAno = clientes.filter(cliente => {
                            if (!cliente.dataCriacao) return false;
                            const dataCriacao = new Date(cliente.dataCriacao);
                            return dataCriacao >= anoInicio && dataCriacao <= anoFim;
                        }).length;
                        
                        values.push(clientesNesteAno);
                    }
                }
                
                console.log('Total de clientes:', clientes.length);
                clientes.forEach((cliente, index) => {
                    console.log(`Cliente ${index + 1}:`, {
                        id: cliente.id,
                        nome: cliente.nome,
                        dataCriacao: cliente.dataCriacao,
                        dataCriacaoObj: cliente.dataCriacao ? new Date(cliente.dataCriacao) : null
                    });
                });
                
                console.log('Dados do gráfico (REAIS):', { labels, values });
                return { labels, values };
            } catch (error) {
                console.error('Erro ao gerar dados do gráfico:', error);
                return { labels: [], values: [] };
            }
        }

        function changeChartPeriod(period) {
            currentChartPeriod = period;
            const buttons = document.querySelectorAll('.chart-control-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            atualizarGrafico();
        }

        window.addEventListener('load', function() {
            carregarClientes();
            carregarNotificacoes();
            atualizarEstatisticas();
            atualizarEstatisticasNotificacoes();
            setTimeout(async () => await atualizarGrafico(), 1000);
            
            window.notificacoesExclusao = 0;
        });
    </script>
</body>
</html>
